#!/bin/sh -e
# postinst script for clusterhat
# see: dh_installdeb(1)

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package

. /usr/share/debconf/confmodule
echo "$@"
case "$1" in
	preconfigure)
		echo "Preconfig.."
	;;
	# Both initialise AND reconfigure
	configure)
		CONFIGFILE=/etc/default/clusterctrl
		## read in configfile
		. $CONFIGFILE

		cat << EOF >> /etc/dhcpcd.conf
# ClusterCTRL
reboot 15
denyinterfaces ethpi* ethupi* ethupi*.10 brint eth0 usb0.10

profile clusterctrl_fallback_usb0
static ip_address=$(echo "$INTERNAL_IP_BASE" | sed "s/{node_index:n}/254/")/24 #ClusterCTRL
static routers=$(echo "$INTERNAL_IP_BASE" | sed "s/{node_index:n}/254/")
static domain_name_servers=192.168.2.109 192.168.2.1 192.168.1.254

profile clusterctrl_fallback_br0
static ip_address=$(echo "$INTERNAL_IP_BASE" | sed "s/{node_index:n}/254/")/24

interface usb0
fallback clusterctrl_fallback_usb0

interface br0
fallback clusterctrl_fallback_br0

# End ClusterCTRL
EOF


		cat << EOF >> /etc/iptables/rules.v4
# ClusterCTRL
# Generated by iptables-save v1.6.0 on Fri Mar 13 00:00:00 2018
*filter
:INPUT ACCEPT [7:1365]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A FORWARD -i br0 ! -o br0 -j ACCEPT
-A FORWARD -o br0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Fri Mar 13 00:00:00 2018
# Generated by iptables-save v1.6.0 on Fri Mar 13 00:00:00 2018
*nat
:PREROUTING ACCEPT [8:1421]
:INPUT ACCEPT [7:1226]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s $(echo "$INTERNAL_IP_BASE" | sed "s/{node_index:n}/0/")/24 ! -o br0 -j MASQUERADE
COMMIT
# Completed on Fri Mar 13 00:00:00 2018
# End ClusterCTRL
EOF
		if command -v raspi-config > /dev/null; then
			echo "Enabled serial and i2c"
			# Enable uart with login
			# Enable I2C (used for I/O expander on Cluster HAT v2.x)
			raspi-config nonint do_serial 0
			raspi-config nonint do_i2c 0
		else
			echo "Raspi-config not found, assuming not on raspberry pi"
		fi

		printf '%s\n' 'mountd: '+$INTERNAL_IP_BASE 'rpcbind: '+$INTERNAL_IP_BASE '' >> /etc/hosts.allow
		printf '%s\n' 'mountd: ALL' 'rpcbind: ALL' '' >> /etc/hosts.deny
		result=$(cat /home/meeple/remote-dir/clusterhat-controller/controllers/share/clusterctrl/interfaces | sed "s/address \(\([0-9]\)\{1,3\}\.\)\{3\}[0-9]\{1,3\}/$(echo "$INTERNAL_IP_BASE" | sed "s/{node_index:n}/254/")/")
		echo $result >> /etc/network/interfaces.d/clusterctrl
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
	;;
	*)
		echo "postinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
